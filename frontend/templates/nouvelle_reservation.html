{% extends "base_dashboard.html" %}

{% block title %}Nouvelle R√©servation{% endblock %}
{% block page_title %}Nouvelle R√©servation{% endblock %}

{% block content %}
<div id="alert-container"></div>

<form id="reservationForm">
    <div class="dotted-section section-green">
        <h2>üìÖ Informations de s√©jour</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="date_arrivee">Date d'arriv√©e *</label>
                <input type="date" id="date_arrivee" name="date_arrivee" required>
            </div>
            <div class="form-group">
                <label for="date_depart">Date de d√©part *</label>
                <input type="date" id="date_depart" name="date_depart" required>
            </div>
            <div class="form-group">
                <label for="nombre_jours">Nombre de jours</label>
                <input type="number" id="nombre_jours" name="nombre_jours" readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group">
                <label for="sejour_numero">Num√©ro de s√©jour</label>
                <input type="text" id="sejour_numero" name="sejour_numero">
            </div>
        </div>
    </div>

    <div class="dotted-section section-purple">
        <h2>üè† S√©lection des chambres</h2>
        <p style="color: #6b7280; margin-bottom: 1rem;">S√©lectionnez une ou plusieurs chambres pour cette r√©servation.</p>
        <div id="chambresSelectionContainer"></div>
    </div>

    <div class="dotted-section section-blue">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">üë• Personnes (Voyageurs)</h2>
            <button type="button" onclick="addPersonne()" class="btn btn-primary btn-small">
                + Ajouter une personne
            </button>
        </div>
        
        <div id="personnesContainer"></div>
    </div>

    <div class="button-group">
        <button type="submit" class="btn btn-success">Enregistrer la r√©servation</button>
        <button type="reset" class="btn btn-secondary">R√©initialiser</button>
        <a href="/dashboard" class="btn btn-secondary">Annuler</a>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script>
    let personneCount = 0;
    let countriesData = [];
    let chambresDisponibles = [];
    let selectedChambres = [];
    
    async function loadChambres() {
        try {
            const response = await fetch('/api/chambres');
            chambresDisponibles = await response.json();
            renderChambresSelection();
        } catch (error) {
            console.error('Erreur chargement chambres:', error);
        }
    }
    
    function renderChambresSelection() {
        const container = document.getElementById('chambresSelectionContainer');
        container.innerHTML = '';
        
        if (chambresDisponibles.length === 0) {
            container.innerHTML = '<p style="color: #ef4444;">Aucune chambre configur√©e. Veuillez d\'abord configurer les chambres dans les param√®tres.</p>';
            return;
        }
        
        const gridHtml = chambresDisponibles.map(chambre => `
            <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem;" class="chambre-option">
                <input type="checkbox" value="${chambre.id}" style="margin-right: 1rem;" onchange="toggleChambre(${chambre.id})">
                <div style="flex: 1;">
                    <strong style="font-size: 1.1em; color: #1f2937;">${chambre.nom}</strong>
                    <div style="color: #6b7280; margin-top: 0.25rem;">
                        üí∞ ${chambre.prix_par_nuit} / nuit &nbsp;|&nbsp; 
                        üë• Capacit√©: ${chambre.capacite} personne(s)
                    </div>
                </div>
            </label>
        `).join('');
        
        container.innerHTML = gridHtml;
    }
    
    function toggleChambre(chambreId) {
        const index = selectedChambres.indexOf(chambreId);
        if (index > -1) {
            selectedChambres.splice(index, 1);
        } else {
            selectedChambres.push(chambreId);
        }
    }
    
    async function loadCountries() {
        try {
            const response = await fetch('/static/data/countries.json');
            countriesData = await response.json();
        } catch (error) {
            console.error('Erreur chargement pays:', error);
        }
    }
    
    function populateCountrySelect(selectElement) {
        selectElement.innerHTML = '<option value="">S√©lectionner un pays...</option>';
        countriesData.forEach(country => {
            const option = document.createElement('option');
            option.value = country.name;
            option.textContent = `${country.flag} ${country.name}`;
            selectElement.appendChild(option);
        });
    }
    
    function calculateDays() {
        const arrivee = document.getElementById('date_arrivee').value;
        const depart = document.getElementById('date_depart').value;
        
        if (arrivee && depart) {
            const start = new Date(arrivee);
            const end = new Date(depart);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            document.getElementById('nombre_jours').value = days > 0 ? days : 0;
        }
    }
    
    document.getElementById('date_arrivee').addEventListener('change', calculateDays);
    document.getElementById('date_depart').addEventListener('change', calculateDays);
    
    function addPersonne() {
        personneCount++;
        const isPrincipal = personneCount === 1;
        
        const personneHtml = `
            <div class="person-card ${isPrincipal ? 'principal' : ''}" id="personne_${personneCount}">
                <div class="person-header">
                    <span class="person-badge">${isPrincipal ? 'Contact Principal' : `Personne ${personneCount}`}</span>
                    ${!isPrincipal ? `<button type="button" class="person-remove" onclick="removePersonne(${personneCount})">Supprimer</button>` : ''}
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" name="personne_nom_${personneCount}" required>
                    </div>
                    <div class="form-group">
                        <label>Pr√©nom *</label>
                        <input type="text" name="personne_prenom_${personneCount}" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="personne_email_${personneCount}">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" name="personne_telephone_${personneCount}">
                    </div>
                    <div class="form-group">
                        <label>Pays</label>
                        <select name="personne_pays_${personneCount}" class="pays-select">
                            <option value="">S√©lectionner un pays...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type pi√®ce d'identit√©</label>
                        <select name="personne_type_piece_${personneCount}">
                            <option value="">S√©lectionner...</option>
                            <option value="passeport">Passeport</option>
                            <option value="cin">CIN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Num√©ro pi√®ce d'identit√©</label>
                        <input type="text" name="personne_numero_piece_${personneCount}">
                    </div>
                    <div class="form-group">
                        <label>Date de naissance</label>
                        <input type="date" name="personne_date_naissance_${personneCount}">
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('personnesContainer').insertAdjacentHTML('beforeend', personneHtml);
        
        const newPersonCard = document.getElementById(`personne_${personneCount}`);
        const paysSelect = newPersonCard.querySelector('.pays-select');
        if (paysSelect && countriesData.length > 0) {
            populateCountrySelect(paysSelect);
        }
    }
    
    function removePersonne(id) {
        document.getElementById(`personne_${id}`).remove();
    }
    
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        
        setTimeout(() => alert.remove(), 5000);
    }
    
    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const reservation = {};
        const personnes = [];
        
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('personne_')) {
                const match = key.match(/personne_(\w+)_(\d+)/);
                if (match) {
                    const [, field, id] = match;
                    const personneIndex = parseInt(id) - 1;
                    
                    if (!personnes[personneIndex]) {
                        personnes[personneIndex] = {};
                    }
                    personnes[personneIndex][field] = value || null;
                }
            } else {
                reservation[key] = value || null;
            }
        }
        
        if (selectedChambres.length === 0) {
            showAlert('Veuillez s√©lectionner au moins une chambre', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    reservation, 
                    personnes: personnes.filter(p => p),
                    chambres: selectedChambres
                })
            });
            
            if (response.ok) {
                showAlert('R√©servation cr√©√©e avec succ√®s !', 'success');
                setTimeout(() => window.location.href = '/reservations', 1500);
            } else {
                showAlert('Erreur lors de la cr√©ation de la r√©servation', 'error');
            }
        } catch (error) {
            showAlert('Erreur de connexion au serveur', 'error');
        }
    });
    
    loadCountries();
    loadChambres();
    addPersonne();
</script>
{% endblock %}
