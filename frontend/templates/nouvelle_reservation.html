{% extends "base_dashboard.html" %}

{% block title %}Nouveau S√©jour{% endblock %}
{% block page_title %}Nouveau S√©jour{% endblock %}

{% block content %}
<div id="alert-container"></div>

<form id="reservationForm">
    <div class="dotted-section section-orange">
        <h2>üè¢ S√©lection de l'√©tablissement</h2>
        <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="etablissement">√âtablissement *</label>
                <select id="etablissement" name="etablissement" required>
                    <option value="">S√©lectionner un √©tablissement...</option>
                </select>
            </div>
        </div>
    </div>

    <div class="dotted-section section-green">
        <h2>üìÖ Informations du s√©jour</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="numero_reservation">Num√©ro de s√©jour</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="numero_reservation" name="numero_reservation" readonly style="flex: 1; background: #f3f4f6;">
                    <button type="button" onclick="genererNumeroReservation()" class="btn btn-primary btn-small">üîÑ G√©n√©rer</button>
                </div>
                <small style="color: #6b7280; margin-top: 0.25rem; display: block;">
                    Le num√©ro est g√©n√©r√© automatiquement selon le format d√©fini pour l'√©tablissement
                </small>
            </div>
            <div class="form-group">
                <label for="date_arrivee">Date d'arriv√©e *</label>
                <input type="date" id="date_arrivee" name="date_arrivee" required>
            </div>
            <div class="form-group">
                <label for="date_depart">Date de d√©part *</label>
                <input type="date" id="date_depart" name="date_depart" required>
            </div>
            <div class="form-group">
                <label for="nombre_jours">Nombre de jours</label>
                <input type="number" id="nombre_jours" name="nombre_jours" readonly style="background: #f3f4f6;">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="observations">Observations / Informations suppl√©mentaires</label>
                <textarea id="observations" name="observations" rows="3" style="resize: vertical;" placeholder="Notes, demandes sp√©ciales, informations importantes..."></textarea>
            </div>
        </div>
    </div>

    <div class="dotted-section section-blue">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">üë• Personnes (Voyageurs)</h2>
            <button type="button" onclick="addPersonne()" class="btn btn-primary btn-small">
                + Ajouter une personne
            </button>
        </div>
        
        <div id="personnesContainer"></div>
    </div>

    <div class="button-group">
        <button type="submit" class="btn btn-success">Enregistrer le s√©jour</button>
        <button type="reset" class="btn btn-secondary">R√©initialiser</button>
        <a href="/dashboard" class="btn btn-secondary">Annuler</a>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script>
    let personneCount = 0;
    let countriesData = [];
    let chambresDisponibles = [];
    let selectedChambres = [];
    let etablissements = [];
    let selectedEtablissement = null;
    
    async function loadEtablissements() {
        try {
            const response = await fetch('/api/etablissements?actif_only=true');
            etablissements = await response.json();
            
            const select = document.getElementById('etablissement');
            select.innerHTML = '<option value="">S√©lectionner un √©tablissement...</option>';
            
            etablissements.forEach(etab => {
                const option = document.createElement('option');
                option.value = etab.id;
                option.textContent = etab.nom_etablissement;
                select.appendChild(option);
            });
            
            if (etablissements.length === 1) {
                select.value = etablissements[0].id;
                selectedEtablissement = etablissements[0].id;
                loadChambres();
                genererNumeroReservation();
            }
        } catch (error) {
            console.error('Erreur chargement √©tablissements:', error);
        }
    }
    
    document.getElementById('etablissement').addEventListener('change', function() {
        selectedEtablissement = this.value;
        if (selectedEtablissement) {
            loadChambres();
            genererNumeroReservation();
        }
    });
    
    async function genererNumeroReservation() {
        if (!selectedEtablissement) {
            alert('Veuillez d\'abord s√©lectionner un √©tablissement');
            return;
        }
        
        try {
            const response = await fetch(`/api/etablissements/${selectedEtablissement}/generer-numero`);
            const data = await response.json();
            if (data.numero) {
                document.getElementById('numero_reservation').value = data.numero;
            }
        } catch (error) {
            console.error('Erreur g√©n√©ration num√©ro:', error);
        }
    }
    
    async function loadChambres() {
        if (!selectedEtablissement) return;
        
        try {
            const response = await fetch(`/api/chambres?etablissement_id=${selectedEtablissement}`);
            chambresDisponibles = await response.json();
            updateChambreDropdowns();
        } catch (error) {
            console.error('Erreur chargement chambres:', error);
        }
    }
    
    function updateChambreDropdowns() {
        const selects = document.querySelectorAll('.chambre-personne-select');
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">S√©lectionner une chambre...</option>';
            chambresDisponibles.forEach(chambre => {
                const option = document.createElement('option');
                option.value = chambre.id;
                option.textContent = `${chambre.nom} (Capacit√©: ${chambre.capacite})`;
                select.appendChild(option);
            });
            if (currentValue) {
                select.value = currentValue;
            }
        });
    }
    
    
    async function loadCountries() {
        try {
            const response = await fetch('/static/data/countries.json');
            countriesData = await response.json();
        } catch (error) {
            console.error('Erreur chargement pays:', error);
        }
    }
    
    function populateCountrySelect(selectElement) {
        selectElement.innerHTML = '<option value="">S√©lectionner un pays...</option>';
        countriesData.forEach(country => {
            const option = document.createElement('option');
            option.value = country.name;
            option.textContent = `${country.flag} ${country.name}`;
            selectElement.appendChild(option);
        });
    }
    
    function calculateDays() {
        const arrivee = document.getElementById('date_arrivee').value;
        const depart = document.getElementById('date_depart').value;
        
        if (arrivee && depart) {
            const start = new Date(arrivee);
            const end = new Date(depart);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            document.getElementById('nombre_jours').value = days > 0 ? days : 0;
        }
    }
    
    document.getElementById('date_arrivee').addEventListener('change', calculateDays);
    document.getElementById('date_depart').addEventListener('change', calculateDays);
    
    function addPersonne() {
        personneCount++;
        const isPrincipal = personneCount === 1;
        
        const personneHtml = `
            <div class="person-card ${isPrincipal ? 'principal' : ''}" id="personne_${personneCount}">
                <div class="person-header">
                    <span class="person-badge">${isPrincipal ? 'Contact Principal' : `Personne ${personneCount}`}</span>
                    ${!isPrincipal ? `<button type="button" class="person-remove" onclick="removePersonne(${personneCount})">Supprimer</button>` : ''}
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom *</label>
                        <input type="text" name="personne_nom_${personneCount}" required>
                    </div>
                    <div class="form-group">
                        <label>Pr√©nom *</label>
                        <input type="text" name="personne_prenom_${personneCount}" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="personne_email_${personneCount}" placeholder="email@exemple.com">
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" name="personne_telephone_${personneCount}" placeholder="+212 XXX XXX XXX">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Pays</label>
                        <select name="personne_pays_${personneCount}" class="pays-select">
                            <option value="">S√©lectionner un pays...</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ville</label>
                        <input type="text" name="personne_ville_${personneCount}" placeholder="Ville de r√©sidence">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Type pi√®ce d'identit√©</label>
                        <select name="personne_type_piece_${personneCount}">
                            <option value="">S√©lectionner...</option>
                            <option value="passeport">Passeport</option>
                            <option value="cin">CIN</option>
                            <option value="cni">CNI</option>
                            <option value="permis_conduire">Permis de conduire</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Num√©ro pi√®ce d'identit√©</label>
                        <input type="text" name="personne_numero_piece_${personneCount}" placeholder="Num√©ro du document">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Date de naissance</label>
                        <input type="date" name="personne_date_naissance_${personneCount}">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Chambre assign√©e</label>
                        <select name="personne_chambre_${personneCount}" class="chambre-personne-select">
                            <option value="">S√©lectionner une chambre...</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('personnesContainer').insertAdjacentHTML('beforeend', personneHtml);
        
        const newPersonCard = document.getElementById(`personne_${personneCount}`);
        const paysSelect = newPersonCard.querySelector('.pays-select');
        if (paysSelect && countriesData.length > 0) {
            populateCountrySelect(paysSelect);
        }
        
        updateChambreDropdowns();
    }
    
    function removePersonne(id) {
        document.getElementById(`personne_${id}`).remove();
    }
    
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        
        setTimeout(() => alert.remove(), 5000);
    }
    
    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!selectedEtablissement) {
            showAlert('Veuillez s√©lectionner un √©tablissement', 'error');
            return;
        }
        
        const formData = new FormData(e.target);
        const reservation = {
            etablissement_id: selectedEtablissement,
            numero_reservation: document.getElementById('numero_reservation').value,
            observations: document.getElementById('observations').value
        };
        const personnes = [];
        
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('personne_')) {
                const match = key.match(/personne_(\w+)_(\d+)/);
                if (match) {
                    const [, field, id] = match;
                    const personneIndex = parseInt(id) - 1;
                    
                    if (!personnes[personneIndex]) {
                        personnes[personneIndex] = {};
                    }
                    
                    if (field === 'chambre') {
                        personnes[personneIndex]['chambre_id'] = value ? parseInt(value) : null;
                    } else {
                        personnes[personneIndex][field] = value || null;
                    }
                }
            } else if (!['etablissement', 'numero_reservation', 'observations'].includes(key)) {
                reservation[key] = value || null;
            }
        }
        
        if (personnes.length === 0) {
            showAlert('Veuillez ajouter au moins une personne', 'error');
            return;
        }
        
        const chambreIds = personnes.map(p => p.chambre_id).filter(id => id);
        const uniqueChambres = [...new Set(chambreIds)];
        
        try {
            const response = await fetch('/api/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    reservation, 
                    personnes: personnes.filter(p => p),
                    chambres: uniqueChambres
                })
            });
            
            if (response.ok) {
                showAlert('S√©jour cr√©√© avec succ√®s !', 'success');
                setTimeout(() => window.location.href = '/reservations', 1500);
            } else {
                const errorData = await response.json();
                showAlert(`Erreur: ${errorData.error || 'Erreur lors de la cr√©ation du s√©jour'}`, 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Erreur de connexion au serveur', 'error');
        }
    });
    
    loadCountries();
    loadEtablissements();
    addPersonne();
</script>
{% endblock %}
