{% extends "base_dashboard.html" %}

{% block title %}Historique des Activités{% endblock %}
{% block page_title %}Historique des Activités{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i data-feather="activity"></i> Historique des Activités</h2>
            <p class="text-muted">Suivi de toutes les actions effectuées sur le système</p>
        </div>
    </div>

    <div class="filter-section">
        <div class="filter-header">
            <i data-feather="filter"></i>
            Filtres
        </div>
        <form id="filterForm">
            <div class="filter-grid">
                <div class="form-group">
                    <label for="filterAction">
                        <i data-feather="activity"></i>
                        Type d'action
                    </label>
                    <select id="filterAction">
                        <option value="">Toutes les actions</option>
                        <option value="login">Connexion</option>
                        <option value="logout">Déconnexion</option>
                        <option value="view_dashboard">Tableau de bord</option>
                        <option value="create_sejour">Créer séjour</option>
                        <option value="view_sejours_list">Liste séjours</option>
                        <option value="view_sejour_detail">Détail séjour</option>
                        <option value="create_client">Créer client</option>
                        <option value="view_clients_list">Liste clients</option>
                        <option value="view_settings">Paramètres</option>
                        <option value="view_statistics">Statistiques</option>
                        <option value="view_extras">Extras</option>
                        <option value="view_messages">Messagerie</option>
                        <option value="view_calendars">Calendriers</option>
                        <option value="create_or_update">Créer/Modifier</option>
                        <option value="delete">Supprimer</option>
                        <option value="update">Modifier</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterStartDate">
                        <i data-feather="calendar"></i>
                        Date début
                    </label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="form-group">
                    <label for="filterEndDate">
                        <i data-feather="calendar"></i>
                        Date fin
                    </label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="filter"></i> Filtrer
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetFilters">
                            <i data-feather="x"></i> Réinitialiser
                        </button>
                        <button type="button" class="btn btn-success" id="exportBtn">
                            <i data-feather="download"></i> Exporter CSV
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="content-block">
        <div class="content-block-header">
            <div class="content-block-title">
                <i data-feather="list"></i>
                Logs d'activité
            </div>
            <span id="totalCount" class="badge badge-cyan"></span>
        </div>
        
        <div id="loadingIndicator" style="display: none; text-align: center; padding: 2rem;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 1rem; color: #6b7280;">Chargement...</p>
        </div>
        
        <div class="table-container">
            <table id="logsTable">
                <thead>
                    <tr>
                        <th>Date/Heure</th>
                        <th>Utilisateur</th>
                        <th>Action</th>
                        <th>Route</th>
                        <th>Méthode</th>
                        <th>IP</th>
                        <th>Statut</th>
                        <th>Détails</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                </tbody>
            </table>
        </div>
        
        <nav aria-label="Pagination des logs" style="margin-top: 1.5rem;">
            <ul class="pagination justify-content-center" id="pagination" style="display: flex; list-style: none; gap: 0.5rem; flex-wrap: wrap; padding: 0;"></ul>
        </nav>
    </div>
</div>

<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailsModalLabel">Détails de l'activité</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="logDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('fr-FR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function getActionLabel(action) {
    const labels = {
        'login': 'Connexion',
        'logout': 'Déconnexion',
        'view_dashboard': 'Tableau de bord',
        'create_sejour': 'Créer séjour',
        'view_sejours_list': 'Liste séjours',
        'view_sejour_detail': 'Détail séjour',
        'create_client': 'Créer client',
        'view_clients_list': 'Liste clients',
        'view_settings': 'Paramètres',
        'view_statistics': 'Statistiques',
        'view_extras': 'Extras',
        'view_messages': 'Messagerie',
        'view_calendars': 'Calendriers',
        'create_or_update': 'Créer/Modifier',
        'delete': 'Supprimer',
        'update': 'Modifier',
        'view_page': 'Voir page',
        'view_new_sejour_form': 'Formulaire nouvelle séjour'
    };
    return labels[action] || action;
}

function getMethodBadge(method) {
    const colors = {
        'GET': 'bg-info',
        'POST': 'bg-success',
        'PUT': 'bg-warning',
        'PATCH': 'bg-warning',
        'DELETE': 'bg-danger'
    };
    return `<span class="badge ${colors[method] || 'bg-secondary'}">${method}</span>`;
}

function getStatusBadge(status) {
    if (!status) return '-';
    let badgeClass = 'bg-secondary';
    if (status >= 200 && status < 300) badgeClass = 'bg-success';
    else if (status >= 300 && status < 400) badgeClass = 'bg-info';
    else if (status >= 400 && status < 500) badgeClass = 'bg-warning';
    else if (status >= 500) badgeClass = 'bg-danger';
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

function loadLogs(page = 1) {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const logsTableBody = document.getElementById('logsTableBody');
    
    loadingIndicator.style.display = 'block';
    logsTableBody.innerHTML = '';
    
    const params = new URLSearchParams({
        page: page,
        per_page: 50,
        ...currentFilters
    });
    
    fetch(`/api/activity-logs?${params}`)
        .then(response => response.json())
        .then(data => {
            loadingIndicator.style.display = 'none';
            
            if (!data.success) {
                console.error('Erreur:', data.error);
                return;
            }
            
            document.getElementById('totalCount').textContent = `${data.total} logs`;
            
            if (data.logs.length === 0) {
                logsTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucun log trouvé</td></tr>';
                return;
            }
            
            data.logs.forEach(log => {
                const userName = log.user_prenom && log.user_nom 
                    ? `${log.user_prenom} ${log.user_nom}` 
                    : log.username;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(log.created_at)}</td>
                    <td>${userName}</td>
                    <td>${getActionLabel(log.action)}</td>
                    <td><code>${log.route}</code></td>
                    <td>${getMethodBadge(log.method)}</td>
                    <td><small>${log.ip_address || '-'}</small></td>
                    <td>${getStatusBadge(log.status_code)}</td>
                    <td>
                        ${log.details ? `<button class="btn btn-sm btn-outline-primary" onclick="showLogDetails(${log.id})">
                            <i data-feather="info"></i>
                        </button>` : '-'}
                    </td>
                `;
                logsTableBody.appendChild(row);
            });
            
            feather.replace();
            
            renderPagination(data.page, data.total_pages);
        })
        .catch(error => {
            loadingIndicator.style.display = 'none';
            console.error('Erreur:', error);
            logsTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erreur lors du chargement des logs</td></tr>';
        });
}

function renderPagination(currentPage, totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Précédent</a>`;
    pagination.appendChild(prevLi);
    
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }
    
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Suivant</a>`;
    pagination.appendChild(nextLi);
}

function changePage(page) {
    currentPage = page;
    loadLogs(page);
}

function showLogDetails(logId) {
    fetch(`/api/activity-logs/${logId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Erreur:', data.error);
                return;
            }
            
            const log = data.log;
            const userName = log.user_prenom && log.user_nom 
                ? `${log.user_prenom} ${log.user_nom}` 
                : log.username;
            
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Utilisateur:</strong> ${userName}</p>
                        <p><strong>Action:</strong> ${getActionLabel(log.action)}</p>
                        <p><strong>Route:</strong> <code>${log.route}</code></p>
                        <p><strong>Méthode:</strong> ${getMethodBadge(log.method)}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>IP:</strong> ${log.ip_address || '-'}</p>
                        <p><strong>Statut:</strong> ${getStatusBadge(log.status_code)}</p>
                        <p><strong>Date/Heure:</strong> ${formatDate(log.created_at)}</p>
                    </div>
                    ${log.user_agent ? `
                    <div class="col-12 mt-2">
                        <p><strong>User Agent:</strong></p>
                        <p class="text-muted small">${log.user_agent}</p>
                    </div>
                    ` : ''}
                    ${log.details ? `
                    <div class="col-12 mt-2">
                        <p><strong>Détails supplémentaires:</strong></p>
                        <pre class="bg-light p-2 rounded">${JSON.stringify(log.details, null, 2)}</pre>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('logDetailsContent').innerHTML = content;
            feather.replace();
            
            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erreur:', error);
        });
}

document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    currentFilters = {};
    
    const action = document.getElementById('filterAction').value;
    if (action) currentFilters.action = action;
    
    const startDate = document.getElementById('filterStartDate').value;
    if (startDate) currentFilters.start_date = startDate + 'T00:00:00';
    
    const endDate = document.getElementById('filterEndDate').value;
    if (endDate) currentFilters.end_date = endDate + 'T23:59:59';
    
    currentPage = 1;
    loadLogs(1);
});

document.getElementById('resetFilters').addEventListener('click', function() {
    document.getElementById('filterForm').reset();
    currentFilters = {};
    currentPage = 1;
    loadLogs(1);
});

document.getElementById('exportBtn').addEventListener('click', function() {
    const params = new URLSearchParams(currentFilters);
    window.location.href = `/api/activity-logs/export?${params}`;
});

loadLogs(1);
</script>
{% endblock %}
