{% extends "base_dashboard.html" %}

{% block title %}Param√®tres{% endblock %}
{% block page_title %}Param√®tres Syst√®me{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="dotted-section section-blue" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">üè¢ Mes √âtablissements</h2>
        <button type="button" onclick="addEtablissement()" class="btn btn-primary">
            ‚ûï Ajouter un √©tablissement
        </button>
    </div>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">G√©rez tous vos √©tablissements. Vous pouvez en ajouter autant que n√©cessaire.</p>
    
    <div id="etablissements-container"></div>
</div>

<div class="dotted-section section-green" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">üè† Chambres</h2>
        <button type="button" onclick="addChambre()" class="btn btn-primary">
            ‚ûï Ajouter une chambre
        </button>
    </div>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">G√©rez les chambres de vos √©tablissements.</p>
    
    <div id="chambres-container"></div>
</div>

<div class="dotted-section section-purple" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">üë• Personnels</h2>
        <button type="button" onclick="addPersonnel()" class="btn btn-primary">
            ‚ûï Ajouter un personnel
        </button>
    </div>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">G√©rez les membres du personnel et d√©finissez les pages auxquelles ils ont acc√®s.</p>
    
    <div id="personnels-container"></div>
</div>

<div class="dotted-section section-orange" style="background: rgba(249, 115, 22, 0.05); border: 3px dotted #f97316; box-shadow: 0 4px 6px rgba(249, 115, 22, 0.1);">
    <h2>üõ†Ô∏è Gestion des donn√©es</h2>
    <p style="color: #6b7280; margin-bottom: 1.5rem;">G√©rez les donn√©es de votre syst√®me : chargement de donn√©es de d√©monstration ou r√©initialisation.</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; border: 2px solid #e5e7eb;">
            <h3 style="margin: 0 0 0.75rem 0; color: #059669;">üì¶ Donn√©es de d√©monstration</h3>
            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                Charger des √©tablissements, chambres, s√©jours et clients de d√©monstration pour tester l'application.
            </p>
            <button type="button" onclick="loadDemoData()" class="btn btn-success" style="width: 100%;">
                üéØ Charger les donn√©es de d√©mo
            </button>
        </div>
        
        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; border: 2px solid #e5e7eb;">
            <h3 style="margin: 0 0 0.75rem 0; color: #dc2626;">üóëÔ∏è R√©initialisation s√©lective</h3>
            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                Supprimer s√©lectivement certaines donn√©es du syst√®me.
            </p>
            <button type="button" onclick="showResetOptions()" class="btn btn-danger" style="width: 100%;">
                ‚öôÔ∏è Options de r√©initialisation
            </button>
        </div>
        
        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; border: 2px solid #e5e7eb;">
            <h3 style="margin: 0 0 0.75rem 0; color: #dc2626;">‚ö†Ô∏è R√©initialisation compl√®te</h3>
            <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                Supprimer TOUTES les donn√©es et remettre √† z√©ro (conserve l'utilisateur admin).
            </p>
            <button type="button" onclick="resetAllData()" class="btn btn-danger" style="width: 100%;">
                üîÑ Tout r√©initialiser
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    console.log('‚úÖ Script parametres.html charg√© - D√âBUT');
    
    let etablissements = [];
    let countriesData = [];
    let editingEtablissement = null;
    
    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
    
    async function loadCountries() {
        try {
            const response = await fetch('/static/data/countries.json');
            countriesData = await response.json();
        } catch (error) {
            console.error('Erreur chargement pays:', error);
        }
    }
    
    function populateCountrySelect(selectElement, selectedValue = '') {
        selectElement.innerHTML = '<option value="">S√©lectionner un pays...</option>';
        countriesData.forEach(country => {
            const option = document.createElement('option');
            option.value = country.name;
            option.textContent = `${country.flag} ${country.name}`;
            if (country.cities) {
                option.dataset.cities = JSON.stringify(country.cities);
            }
            selectElement.appendChild(option);
        });
        if (selectedValue) {
            selectElement.value = selectedValue;
        }
    }
    
    function populateVilleSelect(paysSelect, villeSelect, selectedVille = '') {
        const selectedOption = paysSelect.options[paysSelect.selectedIndex];
        villeSelect.innerHTML = '<option value="">S√©lectionner une ville...</option>';
        
        if (selectedOption && selectedOption.dataset.cities) {
            try {
                const cities = JSON.parse(selectedOption.dataset.cities);
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    villeSelect.appendChild(option);
                });
                villeSelect.disabled = false;
                if (selectedVille) {
                    setTimeout(() => { villeSelect.value = selectedVille; }, 10);
                }
            } catch (e) {
                villeSelect.disabled = true;
            }
        } else {
            villeSelect.disabled = true;
        }
    }
    
    async function loadEtablissements() {
        try {
            const response = await fetch('/api/etablissements?actif_only=false');
            if (!response.ok) {
                throw new Error(`Erreur chargement √©tablissements: ${response.status}`);
            }
            etablissements = await response.json();
            renderEtablissements();
        } catch (error) {
            console.error('Erreur chargement √©tablissements:', error);
            const container = document.getElementById('etablissements-container');
            container.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 2rem;">‚ùå Erreur lors du chargement des √©tablissements. Veuillez actualiser la page.</p>';
        }
    }
    
    function renderEtablissements() {
        const container = document.getElementById('etablissements-container');
        container.innerHTML = '';
        
        if (etablissements.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Aucun √©tablissement. Cliquez sur "Ajouter un √©tablissement" pour commencer.</p>';
            return;
        }
        
        etablissements.forEach((etab, index) => {
            const card = document.createElement('div');
            card.className = 'dotted-section section-green';
            card.style.marginBottom = '1.5rem';
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; color: #059669;">
                        ${etab.actif ? 'üè¢' : '‚≠ï'} ${etab.nom_etablissement || 'Nouvel √©tablissement'}
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-primary btn-small" onclick="editEtablissement(${etab.id})">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button type="button" class="btn ${etab.actif ? 'btn-secondary' : 'btn-success'} btn-small" onclick="toggleEtablissementStatus(${etab.id})">
                            ${etab.actif ? 'üö´ D√©sactiver' : '‚úÖ Activer'}
                        </button>
                        <button type="button" class="btn btn-danger btn-small" onclick="deleteEtablissement(${etab.id})">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; color: #374151;">
                    <div>
                        <strong>Pays:</strong> ${etab.pays || 'Non d√©fini'}
                    </div>
                    <div>
                        <strong>Ville:</strong> ${etab.ville || 'Non d√©finie'}
                    </div>
                    <div>
                        <strong>T√©l√©phone:</strong> ${etab.telephone || 'Non d√©fini'}
                    </div>
                    <div>
                        <strong>Email:</strong> ${etab.email || 'Non d√©fini'}
                    </div>
                    <div>
                        <strong>Devise:</strong> ${etab.devise || 'MAD'}
                    </div>
                    <div>
                        <strong>Statut:</strong> <span style="color: ${etab.actif ? '#059669' : '#dc2626'};">${etab.actif ? 'Actif' : 'Inactif'}</span>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    async function addEtablissement() {
        console.log('‚úÖ addEtablissement appel√©e');
        showEtablissementModal(null);
    }
    
    async function editEtablissement(id) {
        try {
            const response = await fetch(`/api/etablissements/${id}`);
            const etab = await response.json();
            showEtablissementModal(etab);
        } catch (error) {
            console.error('Erreur chargement √©tablissement:', error);
            showAlert('Erreur lors du chargement de l\'√©tablissement', 'error');
        }
    }
    
    async function deleteEtablissement(id) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©tablissement ? Cette action est irr√©versible.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/etablissements/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showAlert('√âtablissement supprim√© avec succ√®s', 'success');
                loadEtablissements();
            } else {
                showAlert('Erreur lors de la suppression', 'error');
            }
        } catch (error) {
            console.error('Erreur suppression:', error);
            showAlert('Erreur lors de la suppression', 'error');
        }
    }
    
    async function toggleEtablissementStatus(id) {
        try {
            const response = await fetch(`/api/etablissements/${id}`);
            const etab = await response.json();
            
            const updateResponse = await fetch(`/api/etablissements/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...etab, actif: !etab.actif })
            });
            
            if (updateResponse.ok) {
                showAlert(`√âtablissement ${!etab.actif ? 'activ√©' : 'd√©sactiv√©'} avec succ√®s`, 'success');
                loadEtablissements();
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Erreur lors du changement de statut', 'error');
        }
    }
    
    function showEtablissementModal(etab) {
        const isEdit = etab !== null;
        editingEtablissement = etab;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;';
        modal.id = 'etablissementModal';
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">${isEdit ? '‚úèÔ∏è Modifier l\'√©tablissement' : '‚ûï Nouvel √©tablissement'}</h2>
                    <button type="button" onclick="closeModal()" class="btn btn-secondary btn-small">‚úñ Fermer</button>
                </div>
                
                <form id="etablissementForm">
                    <div class="dotted-section section-blue" style="margin-bottom: 1.5rem;">
                        <h3>üìù Informations g√©n√©rales</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_nom">Nom de l'√©tablissement *</label>
                                <input type="text" id="etab_nom" value="${etab?.nom_etablissement || ''}" required>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_numero">Num√©ro d'identification (ICE, SIRET, EIN, etc.)</label>
                                <input type="text" id="etab_numero" value="${etab?.numero_identification || ''}" placeholder="Ex: ICE001234567890">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_logo_file">Logo de l'√©tablissement</label>
                                <input type="file" id="etab_logo_file" accept="image/*" style="padding: 0.5rem;">
                                <input type="hidden" id="etab_logo_url" value="${etab?.logo_url || ''}">
                                <div id="etab_logo_preview" style="margin-top: 1rem;">
                                    ${etab?.logo_url ? `<img src="${etab.logo_url}" alt="Logo" style="max-width: 200px; max-height: 100px; border: 2px solid #e5e7eb; border-radius: 8px; padding: 0.5rem;">` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dotted-section section-green" style="margin-bottom: 1.5rem;">
                        <h3>üìç Localisation</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_pays">Pays *</label>
                                <select id="etab_pays" required>
                                    <option value="">S√©lectionner un pays...</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_ville">Ville</label>
                                <select id="etab_ville">
                                    <option value="">S√©lectionner une ville...</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_adresse">Adresse compl√®te</label>
                                <textarea id="etab_adresse" rows="3">${etab?.adresse || ''}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dotted-section section-purple" style="margin-bottom: 1.5rem;">
                        <h3>üìû Contact</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_telephone">T√©l√©phone</label>
                                <input type="tel" id="etab_telephone" value="${etab?.telephone || ''}" placeholder="+212 XXX XXX XXX">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_whatsapp">WhatsApp</label>
                                <input type="tel" id="etab_whatsapp" value="${etab?.whatsapp || ''}" placeholder="+212 XXX XXX XXX">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_email">Email</label>
                                <input type="email" id="etab_email" value="${etab?.email || ''}" placeholder="contact@etablissement.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="dotted-section section-orange" style="margin-bottom: 1.5rem;">
                        <h3>üí∞ Tarification</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="etab_devise">Devise *</label>
                                <select id="etab_devise" required>
                                    <option value="MAD" ${!etab || etab.devise === 'MAD' ? 'selected' : ''}>MAD - Dirham marocain</option>
                                    <option value="EUR" ${etab?.devise === 'EUR' ? 'selected' : ''}>EUR - Euro</option>
                                    <option value="USD" ${etab?.devise === 'USD' ? 'selected' : ''}>USD - Dollar am√©ricain</option>
                                    <option value="GBP" ${etab?.devise === 'GBP' ? 'selected' : ''}>GBP - Livre sterling</option>
                                    <option value="CHF" ${etab?.devise === 'CHF' ? 'selected' : ''}>CHF - Franc suisse</option>
                                    <option value="CAD" ${etab?.devise === 'CAD' ? 'selected' : ''}>CAD - Dollar canadien</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="etab_taxe_sejour">Taxe de s√©jour (%)</label>
                                <input type="number" id="etab_taxe_sejour" step="0.01" value="${etab?.taux_taxe_sejour || 0}">
                            </div>
                            <div class="form-group">
                                <label for="etab_tva">TVA (%)</label>
                                <input type="number" id="etab_tva" step="0.01" value="${etab?.taux_tva || 0}">
                            </div>
                            <div class="form-group">
                                <label for="etab_charge_plateforme">Charge plateforme (%)</label>
                                <input type="number" id="etab_charge_plateforme" step="0.01" value="${etab?.taux_charge_plateforme || 0}">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="etab_format_numero">Format de num√©ro de s√©jour</label>
                                <input type="text" id="etab_format_numero" value="${etab?.format_numero_reservation || 'RES-{YYYY}{MM}{DD}-{NUM}'}">
                                <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                                    Variables: {YYYY} = ann√©e, {MM} = mois, {DD} = jour, {NUM} = num√©ro s√©quentiel
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
                        <button type="button" onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        populateCountrySelect(document.getElementById('etab_pays'), etab?.pays || '');
        
        const paysSelect = document.getElementById('etab_pays');
        const villeSelect = document.getElementById('etab_ville');
        
        paysSelect.addEventListener('change', () => {
            populateVilleSelect(paysSelect, villeSelect);
        });
        
        if (etab?.pays) {
            setTimeout(() => {
                populateVilleSelect(paysSelect, villeSelect, etab?.ville || '');
            }, 50);
        }
        
        // Gestion de l'upload du logo
        document.getElementById('etab_logo_file').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('logo', file);
                
                try {
                    const response = await fetch('/api/etablissements/upload-logo', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('etab_logo_url').value = result.logo_url;
                        document.getElementById('etab_logo_preview').innerHTML = \`
                            <img src="\${result.logo_url}" alt="Logo" style="max-width: 200px; max-height: 100px; border: 2px solid #e5e7eb; border-radius: 8px; padding: 0.5rem;">
                        \`;
                        showAlert('‚úÖ Logo t√©l√©charg√© avec succ√®s!', 'success');
                    } else {
                        showAlert('‚ùå ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Erreur upload logo:', error);
                    showAlert('‚ùå Erreur lors du t√©l√©chargement du logo', 'error');
                }
            }
        });
        
        document.getElementById('etablissementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveEtablissement();
        });
    }
    
    function closeModal() {
        const modal = document.getElementById('etablissementModal');
        if (modal) {
            modal.remove();
        }
        editingEtablissement = null;
    }
    
    async function saveEtablissement() {
        const data = {
            nom_etablissement: document.getElementById('etab_nom').value,
            numero_identification: document.getElementById('etab_numero').value,
            logo_url: document.getElementById('etab_logo_url').value,
            pays: document.getElementById('etab_pays').value,
            ville: document.getElementById('etab_ville').value,
            adresse: document.getElementById('etab_adresse').value,
            telephone: document.getElementById('etab_telephone').value,
            whatsapp: document.getElementById('etab_whatsapp').value,
            email: document.getElementById('etab_email').value,
            devise: document.getElementById('etab_devise').value,
            taux_taxe_sejour: parseFloat(document.getElementById('etab_taxe_sejour').value) || 0,
            taux_tva: parseFloat(document.getElementById('etab_tva').value) || 0,
            taux_charge_plateforme: parseFloat(document.getElementById('etab_charge_plateforme').value) || 0,
            format_numero_reservation: document.getElementById('etab_format_numero').value || 'RES-{YYYY}{MM}{DD}-{NUM}',
            actif: editingEtablissement?.actif !== false
        };
        
        try {
            const isEdit = editingEtablissement !== null;
            const url = isEdit ? `/api/etablissements/${editingEtablissement.id}` : '/api/etablissements';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showAlert(`√âtablissement ${isEdit ? 'modifi√©' : 'cr√©√©'} avec succ√®s`, 'success');
                closeModal();
                loadEtablissements();
            } else {
                showAlert('Erreur lors de l\'enregistrement', 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Erreur lors de l\'enregistrement', 'error');
        }
    }
    
    let chambres = [];
    let personnels = [];
    
    async function loadChambres() {
        try {
            const response = await fetch('/api/chambres');
            chambres = await response.json();
            renderChambres();
        } catch (error) {
            console.error('Erreur chargement chambres:', error);
            showAlert('Erreur lors du chargement des chambres', 'error');
        }
    }
    
    function renderChambres() {
        const container = document.getElementById('chambres-container');
        
        if (chambres.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Aucune chambre. Cliquez sur "Ajouter une chambre" pour commencer.</p>';
            return;
        }
        
        container.innerHTML = chambres.map(chambre => `
            <div class="dotted-section section-blue" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0;">üõèÔ∏è ${chambre.nom || 'Sans nom'}</h3>
                        <p style="color: #6b7280; margin: 0;">Capacit√©: ${chambre.capacite || 0} personne(s) | Prix: ${chambre.prix_par_nuit || 0} MAD/nuit</p>
                        <p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.875rem;">Statut: ${chambre.statut || 'disponible'}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" onclick="editChambre(${chambre.id})" class="btn btn-primary btn-small">‚úèÔ∏è Modifier</button>
                        <button type="button" onclick="deleteChambre(${chambre.id})" class="btn btn-danger btn-small">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    async function addChambre() {
        console.log('‚úÖ addChambre appel√©e');
        showChambreModal(null);
    }
    
    async function editChambre(id) {
        try {
            const response = await fetch(`/api/chambres/${id}`);
            if (!response.ok) {
                throw new Error('Chambre non trouv√©e');
            }
            const chambre = await response.json();
            showChambreModal(chambre);
        } catch (error) {
            console.error('Erreur chargement chambre:', error);
            showAlert('Erreur lors du chargement de la chambre', 'error');
        }
    }
    
    function showChambreModal(chambre) {
        const isEdit = chambre !== null;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem;';
        modal.id = 'chambreModal';
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; padding: 2rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">${isEdit ? '‚úèÔ∏è Modifier la chambre' : '‚ûï Nouvelle chambre'}</h2>
                    <button type="button" onclick="closeChambreModal()" class="btn btn-secondary btn-small">‚úñ Fermer</button>
                </div>
                
                <form id="chambreForm">
                    <div class="dotted-section section-blue" style="margin-bottom: 1.5rem;">
                        <h3>üìù Informations de la chambre</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="chambre_etablissement">√âtablissement *</label>
                                <select id="chambre_etablissement" required>
                                    <option value="">S√©lectionner un √©tablissement...</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="chambre_nom">Nom de la chambre *</label>
                                <input type="text" id="chambre_nom" value="${chambre?.nom || ''}" required placeholder="Ex: Chambre 101">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="chambre_description">Description</label>
                                <textarea id="chambre_description" rows="3" placeholder="Description de la chambre...">${chambre?.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="chambre_capacite">Capacit√© (personnes) *</label>
                                <input type="number" id="chambre_capacite" value="${chambre?.capacite || 2}" required min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label for="chambre_prix">Prix par nuit *</label>
                                <input type="number" id="chambre_prix" value="${chambre?.prix_par_nuit || 0}" required min="0" step="0.01">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="chambre_statut">Statut *</label>
                                <select id="chambre_statut" required>
                                    <option value="disponible" ${!chambre || chambre.statut === 'disponible' ? 'selected' : ''}>Disponible</option>
                                    <option value="occup√©e" ${chambre?.statut === 'occup√©e' ? 'selected' : ''}>Occup√©e</option>
                                    <option value="maintenance" ${chambre?.statut === 'maintenance' ? 'selected' : ''}>En maintenance</option>
                                    <option value="hors_service" ${chambre?.statut === 'hors_service' ? 'selected' : ''}>Hors service</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
                        <button type="button" onclick="closeChambreModal()" class="btn btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const etabSelect = document.getElementById('chambre_etablissement');
        etablissements.filter(e => e.actif).forEach(etab => {
            const option = document.createElement('option');
            option.value = etab.id;
            option.textContent = etab.nom_etablissement;
            if (chambre && chambre.etablissement_id === etab.id) {
                option.selected = true;
            }
            etabSelect.appendChild(option);
        });
        
        if (!isEdit && etablissements.length > 0) {
            const firstActif = etablissements.find(e => e.actif);
            if (firstActif) {
                etabSelect.value = firstActif.id;
            }
        }
        
        document.getElementById('chambreForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveChambre(chambre);
        });
    }
    
    function closeChambreModal() {
        const modal = document.getElementById('chambreModal');
        if (modal) {
            modal.remove();
        }
    }
    
    async function saveChambre(chambre) {
        const data = {
            etablissement_id: parseInt(document.getElementById('chambre_etablissement').value),
            nom: document.getElementById('chambre_nom').value,
            description: document.getElementById('chambre_description').value,
            capacite: parseInt(document.getElementById('chambre_capacite').value),
            prix_par_nuit: parseFloat(document.getElementById('chambre_prix').value),
            statut: document.getElementById('chambre_statut').value
        };
        
        try {
            const isEdit = chambre !== null;
            const url = isEdit ? `/api/chambres/${chambre.id}` : '/api/chambres';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showAlert(`Chambre ${isEdit ? 'modifi√©e' : 'cr√©√©e'} avec succ√®s`, 'success');
                closeChambreModal();
                loadChambres();
            } else {
                const error = await response.json();
                showAlert('Erreur: ' + (error.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Erreur lors de l\'enregistrement', 'error');
        }
    }
    
    async function deleteChambre(id) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette chambre ?')) return;
        
        try {
            const response = await fetch(`/api/chambres/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showAlert('Chambre supprim√©e avec succ√®s', 'success');
                loadChambres();
            }
        } catch (error) {
            showAlert('Erreur lors de la suppression', 'error');
        }
    }
    
    async function loadPersonnels() {
        try {
            const response = await fetch('/api/personnels');
            if (response.ok) {
                personnels = await response.json();
                renderPersonnels();
            } else {
                console.error('Erreur chargement personnels');
            }
        } catch (error) {
            console.error('Erreur chargement personnels:', error);
        }
    }
    
    function renderPersonnels() {
        const container = document.getElementById('personnels-container');
        
        if (personnels.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Aucun personnel. Cliquez sur "Ajouter un personnel" pour commencer.</p>';
            return;
        }
        
        container.innerHTML = personnels.map(personnel => `
            <div class="dotted-section section-purple" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0;">${personnel.actif ? 'üë§' : '‚≠ï'} ${personnel.prenom} ${personnel.nom}</h3>
                        <p style="color: #6b7280; margin: 0;">Poste: ${personnel.poste || 'Non d√©fini'}</p>
                        <p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                            Email: ${personnel.email || 'Non d√©fini'} | T√©l: ${personnel.telephone || 'Non d√©fini'}
                        </p>
                        <p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.875rem;">
                            Statut: <span style="color: ${personnel.actif ? '#059669' : '#dc2626'};">${personnel.actif ? 'Actif' : 'Inactif'}</span>
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" onclick="editPersonnel(${personnel.id})" class="btn btn-primary btn-small">‚úèÔ∏è Modifier</button>
                        <button type="button" onclick="togglePersonnelStatus(${personnel.id})" class="btn ${personnel.actif ? 'btn-secondary' : 'btn-success'} btn-small">
                            ${personnel.actif ? 'üö´ D√©sactiver' : '‚úÖ Activer'}
                        </button>
                        <button type="button" onclick="deletePersonnel(${personnel.id})" class="btn btn-danger btn-small">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function addPersonnel() {
        console.log('‚úÖ addPersonnel appel√©e');
        showPersonnelModal(null);
    }
    
    async function editPersonnel(id) {
        try {
            const response = await fetch(`/api/personnels/${id}`);
            if (!response.ok) {
                throw new Error('Personnel non trouv√©');
            }
            const personnel = await response.json();
            showPersonnelModal(personnel);
        } catch (error) {
            console.error('Erreur chargement personnel:', error);
            showAlert('Erreur lors du chargement du personnel', 'error');
        }
    }
    
    async function togglePersonnelStatus(id) {
        try {
            const response = await fetch(`/api/personnels/${id}`);
            const personnel = await response.json();
            
            const updateResponse = await fetch(`/api/personnels/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...personnel, actif: !personnel.actif })
            });
            
            if (updateResponse.ok) {
                showAlert(`Personnel ${!personnel.actif ? 'activ√©' : 'd√©sactiv√©'} avec succ√®s`, 'success');
                loadPersonnels();
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Erreur lors du changement de statut', 'error');
        }
    }
    
    async function deletePersonnel(id) {
        if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce membre du personnel ?')) return;
        
        try {
            const response = await fetch(`/api/personnels/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showAlert('Personnel supprim√© avec succ√®s', 'success');
                loadPersonnels();
            }
        } catch (error) {
            showAlert('Erreur lors de la suppression', 'error');
        }
    }
    
    function showPersonnelModal(personnel) {
        const isEdit = personnel !== null;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem; overflow-y: auto;';
        modal.id = 'personnelModal';
        
        const pagesOptions = [
            { value: 'dashboard', label: 'Tableau de bord' },
            { value: 'sejours', label: 'S√©jours' },
            { value: 'clients', label: 'Clients' },
            { value: 'parametres', label: 'Param√®tres' },
            { value: 'statistiques', label: 'Statistiques' }
        ];
        
        const pagesAcces = personnel?.pages_acces || [];
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">${isEdit ? '‚úèÔ∏è Modifier le personnel' : '‚ûï Nouveau personnel'}</h2>
                    <button type="button" onclick="closePersonnelModal()" class="btn btn-secondary btn-small">‚úñ Fermer</button>
                </div>
                
                <form id="personnelForm">
                    <div class="dotted-section section-blue" style="margin-bottom: 1.5rem;">
                        <h3>üë§ Informations personnelles</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="personnel_etablissement">√âtablissement *</label>
                                <select id="personnel_etablissement" required>
                                    <option value="">S√©lectionner un √©tablissement...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="personnel_prenom">Pr√©nom *</label>
                                <input type="text" id="personnel_prenom" value="${personnel?.prenom || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="personnel_nom">Nom *</label>
                                <input type="text" id="personnel_nom" value="${personnel?.nom || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="personnel_email">Email</label>
                                <input type="email" id="personnel_email" value="${personnel?.email || ''}" placeholder="exemple@email.com">
                            </div>
                            <div class="form-group">
                                <label for="personnel_telephone">T√©l√©phone</label>
                                <input type="tel" id="personnel_telephone" value="${personnel?.telephone || ''}" placeholder="+212 XXX XXX XXX">
                            </div>
                        </div>
                    </div>
                    
                    <div class="dotted-section section-green" style="margin-bottom: 1.5rem;">
                        <h3>üíº Informations professionnelles</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="personnel_poste">Poste *</label>
                                <input type="text" id="personnel_poste" value="${personnel?.poste || ''}" required placeholder="Ex: R√©ceptionniste, Femme de chambre, Manager">
                            </div>
                            <div class="form-group">
                                <label for="personnel_date_embauche">Date d'embauche</label>
                                <input type="date" id="personnel_date_embauche" value="${personnel?.date_embauche || ''}">
                            </div>
                            <div class="form-group">
                                <label for="personnel_salaire">Salaire</label>
                                <input type="number" id="personnel_salaire" value="${personnel?.salaire || ''}" step="0.01" min="0" placeholder="0.00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="dotted-section section-purple" style="margin-bottom: 1.5rem;">
                        <h3>üîê Acc√®s aux pages</h3>
                        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">
                            S√©lectionnez les pages auxquelles ce membre du personnel aura acc√®s.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${pagesOptions.map(page => `
                                <label style="display: flex; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" name="pages_acces" value="${page.value}" 
                                        ${pagesAcces.includes(page.value) ? 'checked' : ''}
                                        style="margin-right: 0.75rem; width: 18px; height: 18px;">
                                    <span>${page.label}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-success">üíæ Enregistrer</button>
                        <button type="button" onclick="closePersonnelModal()" class="btn btn-secondary">Annuler</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const etabSelect = document.getElementById('personnel_etablissement');
        etablissements.filter(e => e.actif).forEach(etab => {
            const option = document.createElement('option');
            option.value = etab.id;
            option.textContent = etab.nom_etablissement;
            if (personnel && personnel.etablissement_id === etab.id) {
                option.selected = true;
            }
            etabSelect.appendChild(option);
        });
        
        if (!isEdit && etablissements.length > 0) {
            const firstActif = etablissements.find(e => e.actif);
            if (firstActif) {
                etabSelect.value = firstActif.id;
            }
        }
        
        document.getElementById('personnelForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await savePersonnel(personnel);
        });
    }
    
    function closePersonnelModal() {
        const modal = document.getElementById('personnelModal');
        if (modal) {
            modal.remove();
        }
    }
    
    async function savePersonnel(personnel) {
        const checkboxes = document.querySelectorAll('input[name="pages_acces"]:checked');
        const pagesAcces = Array.from(checkboxes).map(cb => cb.value);
        
        const data = {
            etablissement_id: parseInt(document.getElementById('personnel_etablissement').value),
            prenom: document.getElementById('personnel_prenom').value,
            nom: document.getElementById('personnel_nom').value,
            email: document.getElementById('personnel_email').value || null,
            telephone: document.getElementById('personnel_telephone').value || null,
            poste: document.getElementById('personnel_poste').value,
            date_embauche: document.getElementById('personnel_date_embauche').value || null,
            salaire: parseFloat(document.getElementById('personnel_salaire').value) || null,
            pages_acces: pagesAcces,
            actif: personnel?.actif !== false
        };
        
        try {
            const isEdit = personnel !== null;
            const url = isEdit ? `/api/personnels/${personnel.id}` : '/api/personnels';
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showAlert(`Personnel ${isEdit ? 'modifi√©' : 'cr√©√©'} avec succ√®s`, 'success');
                closePersonnelModal();
                loadPersonnels();
            } else {
                const error = await response.json();
                showAlert('Erreur: ' + (error.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Erreur lors de l\'enregistrement', 'error');
        }
    }
    
    async function loadDemoData() {
        if (!confirm('‚ö†Ô∏è Charger les donn√©es de d√©monstration? Cela ajoutera des √©tablissements, chambres, s√©jours et clients de test.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/load-demo-data', {
                method: 'POST'
            });
            
            if (response.ok) {
                showAlert('‚úÖ Donn√©es de d√©monstration charg√©es avec succ√®s!', 'success');
                loadEtablissements();
                loadChambres();
            } else {
                const data = await response.json();
                showAlert('‚ùå Erreur: ' + (data.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('‚ùå Erreur lors du chargement des donn√©es', 'error');
        }
    }
    
    function showResetOptions() {
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 2rem;';
        modal.id = 'resetOptionsModal';
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; padding: 2rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">üóëÔ∏è R√©initialisation s√©lective</h2>
                    <button type="button" onclick="closeResetModal()" class="btn btn-secondary btn-small">‚úñ Fermer</button>
                </div>
                
                <p style="color: #6b7280; margin-bottom: 1.5rem;">S√©lectionnez les donn√©es √† supprimer:</p>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <label style="display: flex; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="reset_reservations" style="margin-right: 0.75rem; width: 18px; height: 18px;">
                        <span><strong>S√©jours et clients</strong> - Supprime tous les s√©jours et leurs clients associ√©s</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="reset_chambres" style="margin-right: 0.75rem; width: 18px; height: 18px;">
                        <span><strong>Chambres</strong> - Supprime toutes les chambres</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="reset_etablissements" style="margin-right: 0.75rem; width: 18px; height: 18px;">
                        <span><strong>√âtablissements</strong> - Supprime tous les √©tablissements (sauf le principal)</span>
                    </label>
                </div>
                
                <div class="button-group" style="margin-top: 1.5rem;">
                    <button type="button" onclick="executeResetSelection()" class="btn btn-danger">Supprimer la s√©lection</button>
                    <button type="button" onclick="closeResetModal()" class="btn btn-secondary">Annuler</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function closeResetModal() {
        const modal = document.getElementById('resetOptionsModal');
        if (modal) {
            modal.remove();
        }
    }
    
    async function executeResetSelection() {
        const resetReservations = document.getElementById('reset_reservations').checked;
        const resetChambres = document.getElementById('reset_chambres').checked;
        const resetEtablissements = document.getElementById('reset_etablissements').checked;
        
        if (!resetReservations && !resetChambres && !resetEtablissements) {
            showAlert('‚ö†Ô∏è Veuillez s√©lectionner au moins une cat√©gorie', 'error');
            return;
        }
        
        const items = [];
        if (resetReservations) items.push('s√©jours et clients');
        if (resetChambres) items.push('chambres');
        if (resetEtablissements) items.push('√©tablissements');
        
        if (!confirm(`‚ö†Ô∏è Confirmer la suppression de: ${items.join(', ')}? Cette action est irr√©versible!`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/reset-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reset_reservations: resetReservations,
                    reset_chambres: resetChambres,
                    reset_etablissements: resetEtablissements
                })
            });
            
            if (response.ok) {
                showAlert('‚úÖ Donn√©es supprim√©es avec succ√®s!', 'success');
                closeResetModal();
                loadEtablissements();
                loadChambres();
            } else{
                const data = await response.json();
                showAlert('‚ùå Erreur: ' + (data.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('‚ùå Erreur lors de la suppression', 'error');
        }
    }
    
    async function resetAllData() {
        if (!confirm('‚ö†Ô∏è ATTENTION! Cela supprimera TOUTES les donn√©es (√©tablissements, chambres, s√©jours, clients). L\'utilisateur admin sera conserv√©. Continuer?')) {
            return;
        }
        
        if (!confirm('‚ö†Ô∏è Derni√®re confirmation: √™tes-vous ABSOLUMENT S√õR? Cette action est IRR√âVERSIBLE!')) {
            return;
        }
        
        try {
            const response = await fetch('/api/reset-all-data', {
                method: 'POST'
            });
            
            if (response.ok) {
                showAlert('‚úÖ Toutes les donn√©es ont √©t√© r√©initialis√©es!', 'success');
                loadEtablissements();
                loadChambres();
            } else {
                const data = await response.json();
                showAlert('‚ùå Erreur: ' + (data.error || 'Erreur inconnue'), 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('‚ùå Erreur lors de la r√©initialisation', 'error');
        }
    }
    
    // Charger les donn√©es imm√©diatement car le script est en fin de page
    (async function() {
        console.log('üöÄ Initialisation de la page param√®tres...');
        try {
            console.log('üìÅ Chargement des pays...');
            await loadCountries();
            console.log('‚úÖ Pays charg√©s:', countriesData.length);
            
            console.log('üè¢ Chargement des √©tablissements...');
            await loadEtablissements();
            console.log('‚úÖ √âtablissements charg√©s:', etablissements.length);
            
            console.log('üè† Chargement des chambres...');
            await loadChambres();
            console.log('‚úÖ Chambres charg√©es:', chambres.length);
            
            console.log('üë• Chargement des personnels...');
            await loadPersonnels();
            console.log('‚úÖ Personnels charg√©s');
            
            console.log('‚ú® Initialisation termin√©e avec succ√®s');
        } catch (error) {
            console.error('‚ùå Erreur lors du chargement initial:', error);
            showAlert('‚ùå Erreur lors du chargement de la page: ' + error.message, 'error');
        }
    })();
    
    console.log('‚úÖ Script parametres.html charg√© - FIN');
    console.log('‚úÖ Fonctions d√©finies:', typeof addEtablissement, typeof addChambre, typeof addPersonnel);
</script>
{% endblock %}
